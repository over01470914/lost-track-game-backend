<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ç”¨æˆ·æ•°æ®ç»Ÿè®¡çœ‹æ¿</title>
        <!-- å¼•å…¥ Bootstrap æ ·å¼ -->
        <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- å¼•å…¥ Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            body {
                background-color: #f8f9fa;
                padding: 20px;
            }
            .card {
                margin-bottom: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .chart-container {
                position: relative;
                height: 300px;
                width: 100%;
            }
            .header-title {
                margin-bottom: 30px;
                border-bottom: 2px solid #007bff;
                padding-bottom: 10px;
            }
        </style>
    </head>
    <body>

        <div class="container">
            <h1 class="header-title">ğŸ“Š ç”¨æˆ·è¿½è¸ªæ•°æ®åˆ†æ</h1>

            <!-- æ¦‚è§ˆå¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">æ€»ç”¨æˆ·æ•°</h5>
                            <h2 id="total-users" class="display-4">Loading...</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">æ€»äº‹ä»¶æ•° (Tracks)</h5>
                            <h2 id="total-tracks" class="display-4">Loading...</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¬¬ä¸€è¡Œå›¾è¡¨ï¼šæ—¶é—´è¶‹åŠ¿ & åœ°ç†åˆ†å¸ƒ -->
            <div
                class="row">
                <!-- æ¯æ—¥æ´»è·ƒè¶‹åŠ¿ (æŠ˜çº¿å›¾) -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">ğŸ“ˆ æ¯æ—¥è®¿é—®è¶‹åŠ¿</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="timelineChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ç”¨æˆ·åœ°ç†åˆ†å¸ƒ (é¥¼å›¾) -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">ğŸŒ ç”¨æˆ·æ¥æºåˆ†å¸ƒ</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="geoChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¬¬äºŒè¡Œå›¾è¡¨ï¼šé¡µé¢è®¿é—® & äº‹ä»¶ç±»å‹ -->
            <div
                class="row">
                <!-- é¡µé¢è®¿é—®é‡ (æŸ±çŠ¶å›¾) -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">ğŸ“„ çƒ­é—¨é¡µé¢è®¿é—®</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="pageChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- äº‹ä»¶ç±»å‹ç»Ÿè®¡ (ç¯å½¢å›¾) -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">ğŸ–±ï¸ äº‹ä»¶äº¤äº’ç±»å‹</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="eventChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // åŸºç¡€é…ç½®
            const apiBase = '/api/stats';

            // è·å–æ•°æ®å¹¶æ¸²æŸ“çš„é€šç”¨å‡½æ•°
            async function fetchData(endpoint) {
                const res = await fetch(`${apiBase}/${endpoint}`);
                const json = await res.json();
                return json.success ? json.data : [];
            }

            // 1. åŠ è½½æ¦‚è§ˆæ•°æ®
            async function loadOverview() {
                const data = await fetchData('overview');
                document.getElementById('total-users').innerText = data.total_users;
                document.getElementById('total-tracks').innerText = data.total_tracks;
            }

            // 2. æ¸²æŸ“æ—¶é—´è¶‹åŠ¿å›¾ (Line Chart)
            async function loadTimelineChart() {
                const data = await fetchData('timeline');
                const ctx = document.getElementById('timelineChart').getContext('2d');

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(item => item._id), // æ—¥æœŸ
                        datasets: [
                            {
                                label: 'æ¯æ—¥äº‹ä»¶æ•°',
                                data: data.map(item => item.count),
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1,
                                fill: true,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)'
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false
                    }
                });
            }

            // 3. æ¸²æŸ“åœ°ç†åˆ†å¸ƒå›¾ (Pie Chart)
            async function loadGeoChart() {
                const data = await fetchData('geolocation');
                const ctx = document.getElementById('geoChart').getContext('2d');

                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(item => item._id), // å›½å®¶
                        datasets: [
                            {
                                data: data.map(item => item.count),
                                backgroundColor: [
                                    '#FF6384',
                                    '#36A2EB',
                                    '#FFCE56',
                                    '#4BC0C0',
                                    '#9966FF'
                                ]
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false
                    }
                });
            }

            // 4. æ¸²æŸ“é¡µé¢ç»Ÿè®¡å›¾ (Bar Chart)
            async function loadPageChart() {
                const data = await fetchData('pages');
                const ctx = document.getElementById('pageChart').getContext('2d');

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(item => item._id), // é¡µé¢è·¯å¾„
                        datasets: [
                            {
                                label: 'è®¿é—®æ¬¡æ•°',
                                data: data.map(item => item.count),
                                backgroundColor: '#36A2EB'
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // 5. æ¸²æŸ“äº‹ä»¶ç±»å‹å›¾ (Doughnut Chart)
            async function loadEventChart() {
                const data = await fetchData('events');
                const ctx = document.getElementById('eventChart').getContext('2d');

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(item => item._id), // äº‹ä»¶ç±»å‹
                        datasets: [
                            {
                                data: data.map(item => item.count),
                                backgroundColor: ['#FF9F40', '#FFCD56', '#4BC0C0', '#36A2EB']
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false
                    }
                });
            }

            // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
            window.onload = () => {
                loadOverview();
                loadTimelineChart();
                loadGeoChart();
                loadPageChart();
                loadEventChart();
            };
        </script>

    </body>
</html>
