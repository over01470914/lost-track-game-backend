<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Analytics Dashboard</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <style>:root
        {
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
        }
        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: sans-serif;
            padding-bottom: 50px;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
        }
        .nav-tabs .nav-link {
            color: #888;
            border: none;
        }
        .nav-tabs .nav-link.active {
            background-color: transparent;
            color: var(--accent-blue);
            border-bottom: 2px solid var(--accent-blue);
            font-weight: bold;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* é¡¶éƒ¨æ—¶é—´æ ·å¼ */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        .live-clock {
            text-align: right;
        }
        .live-clock .time {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-blue);
        }
        .live-clock .date {
            font-size: 0.9rem;
            color: #888;
        }
    </style>
</head>
<body>

    <div
        class="container">
        <!-- 1. é¡¶éƒ¨ Header & æ—¶é—´ -->
        <div class="header-section">
            <div>
                <h2 class="m-0">ğŸ“Š Dashboard</h2>
                <span class="text-muted" style="font-size: 0.9rem;">Product Analytics</span>
            </div>
            <div class="live-clock">
                <div class="time" id="clock-time">00:00:00</div>
                <div class="date" id="clock-date">YYYY-MM-DD</div>
            </div>
        </div>

        <!-- 2. å¯¼èˆª Tab (å·¦å³åˆ‡æ¢æ¿å—) -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="total-tab" data-bs-toggle="tab" data-bs-target="#total-pane" type="button">ğŸŒ æ€»è§ˆ (Total)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily-pane" type="button">ğŸ“… æ—¥è§†å›¾ (Daily)</button>
            </li>
        </ul>

        <!-- Tab å†…å®¹åŒº -->
        <div
            class="tab-content" id="myTabContent">

            <!-- ================= æ¿å— 1: æ€»è§ˆ (Total) ================= -->
            <div
                class="tab-pane fade show active" id="total-pane">
                <!-- æ ¸å¿ƒ KPI -->
                <div class="row mb-3">
                    <div class="col-6 col-md-3">
                        <div class="card p-3">
                            <small class="text-muted">Total Users</small>
                            <h3 id="total-users">0</h3>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card p-3">
                            <small class="text-muted">Total Views</small>
                            <h3 id="total-tracks">0</h3>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card p-3">
                            <small class="text-muted">Avg Stay Time</small>
                            <h3 id="total-time">0s</h3>
                        </div>
                    </div>
                </div>

                <!-- å›¾è¡¨ï¼šè®¿é—®é‡:æ—¥æœŸ (çº¿å›¾) -->
                <div class="card">
                    <div class="card-header">ğŸ“ˆ å†å²è®¿é—®è¶‹åŠ¿ (All Time Trend)</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="totalTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- çƒ­é—¨ç»„ä»¶æ’è¡Œ -->
                <div class="card mt-3">
                    <div class="card-header">ğŸ”¥ çƒ­é—¨äº¤äº’ç»„ä»¶ Top 10</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="totalTargetChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= æ¿å— 2: æ—¥è§†å›¾ (Daily) ================= -->
            <div
                class="tab-pane fade" id="daily-pane">
                <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
                <div class="d-flex align-items-center mb-4 p-3 bg-dark rounded border border-secondary">
                    <label class="me-3 text-white">é€‰æ‹©æ—¥æœŸ:</label>
                    <input type="date" id="datePicker" class="form-control form-control-sm" style="width: auto; background:#333; color:white; border:none;">
                    <button class="btn btn-primary btn-sm ms-3" onclick="loadDailyData()">æŸ¥è¯¢</button>
                </div>

                <!-- å½“æ—¥ KPI -->
                <div class="row mb-3">
                    <div class="col-4">
                        <div class="card p-3 text-center border-primary">
                            <small class="text-muted">æ´»è·ƒç”¨æˆ·</small>
                            <h3 id="daily-users" class="text-primary">0</h3>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card p-3 text-center">
                            <small class="text-muted">ä»Šæ—¥äº¤äº’</small>
                            <h3 id="daily-tracks">0</h3>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card p-3 text-center">
                            <small class="text-muted">å¹³å‡åœç•™</small>
                            <h3 id="daily-time">0s</h3>
                        </div>
                    </div>
                </div>

                <div
                    class="row">
                    <!-- å›¾è¡¨ï¼šåœ°åŒº:è®¿é—®é‡ (æŸ±çŠ¶å›¾) -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">ğŸŒ åœ°åŒºåˆ†å¸ƒ (æŒ‰è®¿é—®é‡)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="dailyGeoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å›¾è¡¨ï¼šå°æ—¶æµé‡è¶‹åŠ¿ (æ–°æŒ‡æ ‡) -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">â° ä»Šæ—¥æ´»è·ƒæ—¶æ®µ (0-24h)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="dailyHourlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- å¼•å…¥ Bootstrap JS (ç”¨äº Tab åˆ‡æ¢) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 0. å·¥å…·å‡½æ•° ---
        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        function formatTime(ms) {
            if (! ms) 
                return '0s';
            

            return ms < 1000 ? ms + 'ms' : (ms / 1000).toFixed(1) + 's';
        }

        // å®æ—¶æ—¶é’Ÿ
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').innerText = now.toLocaleTimeString();
            document.getElementById('clock-date').innerText = now.toLocaleDateString();
        }
        setInterval(updateClock, 1000);
        updateClock();

        // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤ä»Šå¤©
        document.getElementById('datePicker').valueAsDate = new Date();

        const apiBase = '/api/stats';
        let charts = {};
        // å­˜å‚¨å›¾è¡¨å®ä¾‹ï¼Œæ–¹ä¾¿é”€æ¯

        // é€šç”¨ Fetch
        async function fetchData(endpoint) {
            try {
                const res = await fetch(`${apiBase}/${endpoint}`);
                const json = await res.json();
                return json.success ? json.data : null;
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        // --- 1. åŠ è½½ã€æ€»è§ˆã€‘æ•°æ® ---
        async function loadTotalData() { // KPI
            const ov = await fetchData('overview');
            const time = await fetchData('staytime');
            if (ov) {
                document.getElementById('total-users').innerText = ov.total_users;
                document.getElementById('total-tracks').innerText = ov.total_tracks;
            }
            if (time) 
                document.getElementById('total-time').innerText = formatTime(time);
            


            // è¶‹åŠ¿å›¾ (Line)
            const timeline = await fetchData('timeline');
            if (timeline) {
                renderChart('totalTimelineChart', 'line', {
                    labels: timeline.map(d => d._id),
                    datasets: [
                        {
                            label: 'æ¯æ—¥è®¿é—®',
                            data: timeline.map(d => d.count),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                });
            }

            // ç»„ä»¶æ’è¡Œ (Bar)
            const targets = await fetchData('targets');
            if (targets) {
                renderChart('totalTargetChart', 'bar', {
                    labels: targets.map(d => d._id),
                    datasets: [
                        {
                            label: 'ç‚¹å‡»æ¬¡æ•°',
                            data: targets.map(d => d.count),
                            backgroundColor: '#8b5cf6'
                        }
                    ]
                }, {indexAxis: 'y'}); // æ¨ªå‘
            }
        }

        // --- 2. åŠ è½½ã€æ—¥è§†å›¾ã€‘æ•°æ® ---
        async function loadDailyData() {
            const date = document.getElementById('datePicker').value;
            if (! date) 
                return;
            


            // åŠ è½½ Daily KPI
            const overview = await fetchData(`daily/overview?date=${date}`);
            if (overview) {
                document.getElementById('daily-users').innerText = overview.active_users;
                document.getElementById('daily-tracks').innerText = overview.total_interactions;
                document.getElementById('daily-time').innerText = formatTime(overview.avg_stay_time);
            }

            // åŠ è½½ Daily Geo (Bar Chart)
            const geo = await fetchData(`daily/geolocation?date=${date}`);
            if (geo) {
                renderChart('dailyGeoChart', 'bar', {
                    labels: geo.map(d => d._id),
                    datasets: [
                        {
                            label: 'è®¿é—®é‡',
                            data: geo.map(d => d.count),
                            backgroundColor: '#10b981'
                        }
                    ]
                });
            }

            // åŠ è½½ Daily Hourly (Line Chart)
            const hourly = await fetchData(`daily/hourly?date=${date}`);
            if (hourly) { // è¡¥å…¨ 0-23 å°æ—¶ï¼Œé˜²æ­¢æ–­è£‚
                const hours = Array.from({
                    length: 24
                }, (_, i) => i);
                const dataMap = {};
                hourly.forEach(d => dataMap[d._id] = d.count);
                const counts = hours.map(h => dataMap[h] || 0);

                renderChart('dailyHourlyChart', 'line', {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [
                        {
                            label: 'æ¯å°æ—¶çƒ­åº¦',
                            data: counts,
                            borderColor: '#f59e0b',
                            tension: 0.4,
                            fill: true,
                            backgroundColor: 'rgba(245, 158, 11, 0.1)'
                        }
                    ]
                });
            }
        }

        // --- å›¾è¡¨æ¸²æŸ“æ ¸å¿ƒ (è‡ªåŠ¨é”€æ¯æ—§å›¾è¡¨) ---
        function renderChart(canvasId, type, data, extraOptions = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            }
                        }
                    },
                    ...extraOptions
                }
            });
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            loadTotalData();
            loadDailyData(); // é»˜è®¤åŠ è½½ä»Šå¤©
        };

        // ç›‘å¬ Tab åˆ‡æ¢ï¼Œåˆ‡æ¢æ—¶å¯èƒ½éœ€è¦é‡æ–°è°ƒæ•´å›¾è¡¨å°ºå¯¸ (å¯é€‰)
        const triggerTabList = document.querySelectorAll('button[data-bs-toggle="tab"]')
        triggerTabList.forEach(triggerEl => {
            const tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('shown.bs.tab', event => { // Tab åˆ‡æ¢åè§¦å‘ä¸€ä¸‹ resize ç¡®ä¿ Chart.js æ¸²æŸ“æ­£ç¡®
                window.dispatchEvent(new Event('resize'));
            })
        })
    </script>

</body></html>
