<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Analytics Dashboard</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <style>:root
        {
            --bg-dark: #0f172a; /* æ›´æ·±é‚ƒçš„èƒŒæ™¯è“é»‘ */
            --card-bg: #1e293b; /* ç¨å¾®äº®ä¸€ç‚¹çš„å¡ç‰‡èƒŒæ™¯ */
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-primary: #3b82f6; /* Blue */
            --accent-success: #10b981; /* Green */
            --accent-warn: #f59e0b; /* Orange */
            --accent-purple: #8b5cf6; /* Purple */
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding-bottom: 60px;
        }

        /* é¡¶éƒ¨ Header */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .live-clock .time {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            letter-spacing: 1px;
        }
        .live-clock .date {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: right;
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card {
            background-color: var(--card-bg);
            border: none; /* ç§»é™¤è¾¹æ¡†ï¼Œæ›´ç°ä»£ */
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 24px;
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 16px 20px;
        }

        .card-body {
            padding: 20px;
        }

        /* KPI æ•°å­—å¡ç‰‡ */
        .kpi-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0;
            color: #fff;
        }
        .kpi-card small {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: block;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        /* å¯¼èˆª Tab æ ·å¼ */
        .nav-tabs {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 24px;
        }
        .nav-tabs .nav-link {
            color: var(--text-muted);
            border: none;
            padding: 12px 20px;
            transition: all 0.2s;
        }
        .nav-tabs .nav-link:hover {
            color: #fff;
        }
        .nav-tabs .nav-link.active {
            background-color: transparent;
            color: var(--accent-primary);
            border-bottom: 3px solid var(--accent-primary);
            font-weight: bold;
        }

        /* æ—¥æœŸé€‰æ‹©å™¨ç¾åŒ– */
        .date-picker-container {
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        input[type="date"] {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }
        .chart-container-sm {
            position: relative;
            height: 260px;
            width: 100%;
        }
    </style>
</head>
<body>

    <div
        class="container">
        <!-- 1. é¡¶éƒ¨ Header & æ—¶é—´ -->
        <div class="header-section">
            <div>
                <h2 class="m-0 fw-bold">Analytics Dashboard</h2>
                <span class="text-muted">Lost Track Web Analytics</span>
            </div>
            <div class="live-clock">
                <div class="time" id="clock-time">00:00:00</div>
                <div class="date" id="clock-date">YYYY-MM-DD</div>
            </div>
        </div>

        <!-- 2. å¯¼èˆª Tab (æ—¥è§†å›¾åœ¨å‰) -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily-pane" type="button">ğŸ“… æ—¥è§†å›¾ (Daily)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="total-tab" data-bs-toggle="tab" data-bs-target="#total-pane" type="button">ğŸŒ æ€»è§ˆ (Overview)</button>
            </li>
        </ul>

        <div
            class="tab-content" id="dashboardTabContent">

            <!-- =============================================é¢æ¿ 1: æ—¥è§†å›¾ (Daily View) - é»˜è®¤æ˜¾ç¤º  åŒ…å«: ä»Šæ—¥äº¤äº’æ•°ï¼Œå¹³å‡åœç•™ï¼Œæ´»è·ƒæ—¶æ®µï¼Œåœ°åŒºåˆ†å¸ƒ(æ—¥)============================================== -->
            <div
                class="tab-pane fade show active" id="daily-pane">

                <!-- æ—¥æœŸæ§åˆ¶æ  -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="date-picker-container">
                        <span class="text-muted small">SELECT DATE</span>
                        <input type="date" id="datePicker">
                        <button class="btn btn-sm btn-primary ms-2" onclick="loadDailyData()">Apply</button>
                    </div>
                </div>

                <!-- ç¬¬ä¸€è¡Œ: KPI (äº¤äº’æ•° + åœç•™æ—¶é—´) -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card kpi-card">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div>
                                    <small>Today's Interactions</small>
                                    <h3 id="daily-tracks">0</h3>
                                </div>
                                <div class="text-primary fs-1 opacity-25">ğŸ–±ï¸</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card kpi-card">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div>
                                    <small>Avg. Stay Time (Daily)</small>
                                    <h3 id="daily-time">0s</h3>
                                </div>
                                <div class="text-success fs-1 opacity-25">â±ï¸</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œ: å›¾è¡¨ (æ´»è·ƒæ—¶æ®µ + åœ°åŒºåˆ†å¸ƒ) -->
                <div
                    class="row">
                    <!-- æ´»è·ƒæ—¶æ®µ (çº¿å›¾) -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">â° æ´»è·ƒæ—¶æ®µ (Hourly Activity)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="dailyHourlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- åœ°åŒºåˆ†å¸ƒ (æŸ±çŠ¶å›¾) -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">ğŸ“ åœ°åŒºåˆ†å¸ƒ (Daily Geo)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="dailyGeoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =============================================é¢æ¿ 2: æ€»è§ˆ (Overview) åŒ…å«: Total Users, Views, Avg Time, Trend, Components, Geo(Total)============================================== -->
            <div
                class="tab-pane fade" id="total-pane">

                <!-- ç¬¬ä¸€è¡Œ: KPI (Users, Views, Time) -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="card kpi-card">
                            <div class="card-body">
                                <small>Total Users</small>
                                <h3 id="total-users" class="text-white">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card kpi-card">
                            <div class="card-body">
                                <small>Total Views</small>
                                <h3 id="total-tracks" class="text-white">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card kpi-card">
                            <div class="card-body">
                                <small>Avg. Stay Time (All Time)</small>
                                <h3 id="total-time" class="text-white">0s</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œ: å†å²è¶‹åŠ¿ (All Time Trend) -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">ğŸ“ˆ å†å²è®¿é—®è¶‹åŠ¿ (All Time Trend)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="totalTimelineChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰è¡Œ: çƒ­é—¨ç»„ä»¶ + æ€»åœ°åŒºåˆ†å¸ƒ -->
                <div class="row">
                    <div class="col-lg-7">
                        <div class="card">
                            <div class="card-header">ğŸ”¥ çƒ­é—¨äº¤äº’ç»„ä»¶ (Popular Components)</div>
                            <div class="card-body">
                                <div class="chart-container-sm">
                                    <canvas id="totalTargetChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="card">
                            <div class="card-header">ğŸŒ åœ°åŒºåˆ†å¸ƒ (Total Geo)</div>
                            <div class="card-body">
                                <div class="chart-container-sm">
                                    <canvas id="totalGeoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- é…ç½® ---
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';

        const apiBase = '/api/stats';
        let charts = {};
        // å›¾è¡¨å®ä¾‹å®¹å™¨

        // --- å·¥å…·å‡½æ•° ---
        function formatTime(ms) {
            if (! ms) 
                return '0s';
            


            return ms < 1000 ? ms + 'ms' : (ms / 1000).toFixed(1) + 's';
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').innerText = now.toLocaleTimeString();
            document.getElementById('clock-date').innerText = now.toLocaleDateString(undefined, {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤ä»Šå¤©
        document.getElementById('datePicker').valueAsDate = new Date();

        async function fetchData(endpoint) {
            try {
                const res = await fetch(`${apiBase}/${endpoint}`);
                const json = await res.json();
                return json.success ? json.data : null;
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        function renderChart(id, type, data, options = {}) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) 
                charts[id].destroy();
            


            charts[id] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            }
                        }
                    },
                    ...options
                }
            });
        }

        // --- 1. åŠ è½½ã€æ—¥è§†å›¾ã€‘æ•°æ® (é»˜è®¤) ---
        async function loadDailyData() {
            const date = document.getElementById('datePicker').value;
            if (! date) 
                return;
            


            // KPI
            const overview = await fetchData(`daily/overview?date=${date}`);
            if (overview) {
                document.getElementById('daily-tracks').innerText = overview.total_interactions;
                document.getElementById('daily-time').innerText = formatTime(overview.avg_stay_time);
            }

            // æ´»è·ƒæ—¶æ®µ (Line)
            const hourly = await fetchData(`daily/hourly?date=${date}`);
            if (hourly) {
                const hours = Array.from({
                    length: 24
                }, (_, i) => i);
                const dataMap = {};
                hourly.forEach(d => dataMap[d._id] = d.count);

                // åˆ›å»ºæ¸å˜è‰²
                const ctx = document.getElementById('dailyHourlyChart').getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(245, 158, 11, 0.4)'); // Orange
                gradient.addColorStop(1, 'rgba(245, 158, 11, 0.0)');

                renderChart('dailyHourlyChart', 'line', {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [
                        {
                            label: 'Interactions',
                            data: hours.map(h => dataMap[h] || 0),
                            borderColor: '#f59e0b',
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                });
            }

            // åœ°åŒºåˆ†å¸ƒ (Bar)
            const geo = await fetchData(`daily/geolocation?date=${date}`);
            if (geo) {
                renderChart('dailyGeoChart', 'bar', {
                    labels: geo.map(d => d._id),
                    datasets: [
                        {
                            label: 'Views',
                            data: geo.map(d => d.count),
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }
                    ]
                });
            }
        }

        // --- 2. åŠ è½½ã€æ€»è§ˆã€‘æ•°æ® (æ‡’åŠ è½½) ---
        async function loadTotalData() { // KPI
            const ov = await fetchData('overview');
            const time = await fetchData('staytime');
            if (ov) {
                document.getElementById('total-users').innerText = ov.total_users;
                document.getElementById('total-tracks').innerText = ov.total_tracks;
            }
            if (time) 
                document.getElementById('total-time').innerText = formatTime(time);
            


            // All Time Trend (Line)
            const timeline = await fetchData('timeline');
            if (timeline) {
                const ctx = document.getElementById('totalTimelineChart').getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)'); // Blue
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

                renderChart('totalTimelineChart', 'line', {
                    labels: timeline.map(d => d._id),
                    datasets: [
                        {
                            label: 'Daily Visits',
                            data: timeline.map(d => d.count),
                            borderColor: '#3b82f6',
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                });
            }

            // çƒ­é—¨ç»„ä»¶ (Horizontal Bar)
            const targets = await fetchData('targets');
            if (targets) {
                renderChart('totalTargetChart', 'bar', {
                    labels: targets.map(d => d._id),
                    datasets: [
                        {
                            data: targets.map(d => d.count),
                            backgroundColor: '#8b5cf6',
                            borderRadius: 4
                        }
                    ]
                }, {indexAxis: 'y'});
            }

            // åœ°åŒºåˆ†å¸ƒ - æ€» (Doughnut)
            const geo = await fetchData('geolocation');
            if (geo) {
                renderChart('totalGeoChart', 'doughnut', {
                    labels: geo.map(d => d._id),
                    datasets: [
                        {
                            data: geo.map(d => d.count),
                            backgroundColor: [
                                '#3b82f6',
                                '#8b5cf6',
                                '#10b981',
                                '#f59e0b',
                                '#ef4444'
                            ],
                            borderWidth: 0
                        }
                    ]
                }, {
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                color: '#94a3b8'
                            }
                        }
                    }
                });
            }
        }

        // --- åˆå§‹åŒ–ä¸äº‹ä»¶ç›‘å¬ ---
        window.onload = () => {
            loadDailyData();
            // é»˜è®¤åŠ è½½æ—¥è§†å›¾

            // åªæœ‰å½“ç¬¬ä¸€æ¬¡ç‚¹å‡» "æ€»è§ˆ" Tab æ—¶æ‰åŠ è½½æ€»è§ˆæ•°æ®
            const totalTabBtn = document.getElementById('total-tab');
            totalTabBtn.addEventListener('shown.bs.tab', () => {
                loadTotalData();
            }, {once: true}); // åªæ‰§è¡Œä¸€æ¬¡
        };

        // Tab åˆ‡æ¢æ—¶è§¦å‘ resize ç¡®ä¿å›¾è¡¨æ¸²æŸ“æ­£å¸¸
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(el => {
            el.addEventListener('shown.bs.tab', () => {
                window.dispatchEvent(new Event('resize'));
            });
        });
    </script>

</body></html>
