<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Analytics Dashboard</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

                    <style>:root
                    {
                        --bg-dark: #0f172a;
                        --card-bg: #1e293b;
                        --text-main: #e2e8f0;
                        --text-muted: #94a3b8;
                        --accent-primary: #3b82f6;
                        --accent-success: #10b981;
                        --accent-warn: #f59e0b;
                        --accent-purple: #8b5cf6;
                    }

                    body {
                        background-color: var(--bg-dark);
                        color: var(--text-main);
                        font-family: 'Inter', system-ui, -apple-system, sans-serif;
                        padding-bottom: 60px;
                    }

                    /* È°∂ÈÉ® Header */
                    .header-section {
                        padding: 24px 0;
                        margin-bottom: 20px;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .live-clock .time {
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: var(--accent-primary);
                        letter-spacing: 1px;
                    }
                    .live-clock .date {
                        font-size: 0.85rem;
                        color: var(--text-muted);
                        text-align: right;
                    }

                    /* Âç°ÁâáÊ†∑Âºè */
                    .card {
                        background-color: var(--card-bg);
                        border: none;
                        border-radius: 12px;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                        margin-bottom: 24px;
                    }
                    .card-header {
                        background: transparent;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                        font-size: 0.85rem;
                        font-weight: 600;
                        color: var(--text-muted);
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        padding: 15px 20px;
                    }
                    .card-body {
                        padding: 20px;
                    }

                    /* KPI Êï∞Â≠ó */
                    .kpi-card h3 {
                        font-size: 2rem;
                        font-weight: 700;
                        color: #fff;
                        margin: 0;
                    }
                    .kpi-card small {
                        font-size: 0.8rem;
                        color: var(--text-muted);
                        text-transform: uppercase;
                        display: block;
                        margin-bottom: 5px;
                    }

                    /* Tab Ê†∑Âºè */
                    .nav-tabs {
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                        margin-bottom: 24px;
                    }
                    .nav-tabs .nav-link {
                        color: var(--text-muted);
                        border: none;
                        padding: 10px 20px;
                    }
                    .nav-tabs .nav-link:hover {
                        color: #fff;
                    }
                    .nav-tabs .nav-link.active {
                        background: transparent;
                        color: var(--accent-primary);
                        border-bottom: 2px solid var(--accent-primary);
                        font-weight: bold;
                    }

                    /* Êó•ÊúüÈÄâÊã©Âô®Âå∫Âüü */
                    .date-control-bar {
                        background: var(--card-bg);
                        padding: 12px 20px;
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        flex-wrap: wrap;
                        border: 1px solid rgba(255, 255, 255, 0.05);
                        margin-bottom: 24px;
                    }
                    .date-input-group {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    input[type="date"] {
                        background: rgba(0, 0, 0, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        color: #fff;
                        padding: 6px 10px;
                        border-radius: 6px;
                        font-size: 0.9rem;
                        outline: none;
                    }
                    input[type="date"]::-webkit-calendar-picker-indicator {
                        filter: invert(1);
                        cursor: pointer;
                    }

                    /* ÂõæË°®ÂÆπÂô® */
                    .chart-container {
                        position: relative;
                        height: 300px;
                        width: 100%;
                    }
                    .chart-container-sm {
                        position: relative;
                        height: 250px;
                        width: 100%;
                    }
                </style>
            </head>
            <body>

                <div
                    class="container">
                    <!-- Header -->
                    <div class="header-section">
                        <div>
                            <h2 class="m-0 fw-bold">Analytics</h2>
                            <span class="text-muted">User Insights Dashboard</span>
                        </div>
                        <div class="live-clock">
                            <div class="time" id="clock-time">00:00:00</div>
                            <div class="date" id="clock-date">loading...</div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <ul class="nav nav-tabs" id="mainTab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="range-tab" data-bs-toggle="tab" data-bs-target="#range-pane" type="button">üìÖ Âå∫Èó¥ËßÜÂõæ (Range View)</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="total-tab" data-bs-toggle="tab" data-bs-target="#total-pane" type="button">üåç ÊÄªËßà (Total Overview)</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button">‚öôÔ∏è ËÆæÁΩÆ (Settings)</button>
                        </li>

                    </ul>

                    <div
                        class="tab-content">

                        <!-- ================= PANEL 1: Âå∫Èó¥ËßÜÂõæ (Âê´ÁÉ≠Èó®ÁªÑ‰ª∂) ================= -->
                        <div
                            class="tab-pane fade show active" id="range-pane">

                            <!-- Êó•ÊúüÊéßÂà∂Âô® -->
                            <div class="date-control-bar">
                                <span class="text-muted small fw-bold">DATE RANGE:</span>
                                <div class="date-input-group">
                                    <input type="date" id="startDate">
                                        <span class="text-muted">-</span>
                                        <input type="date" id="endDate"></div>
                                        <button class="btn btn-sm btn-primary px-3" onclick="loadRangeData()">üîç Query</button>
                                        <div class="vr mx-2 bg-secondary opacity-25"></div>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="resetToToday()">‚èÆ Today</button>
                                    </div>

                                    <!-- KPI Row -->
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card kpi-card">
                                                <div class="card-body">
                                                    <small>Active Users (In Range)</small>
                                                    <h3 id="range-users">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card kpi-card">
                                                <div class="card-body">
                                                    <small>Interactions</small>
                                                    <h3 id="range-tracks">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card kpi-card">
                                                <div class="card-body">
                                                    <small>Avg. Stay Time</small>
                                                    <h3 id="range-time">0s</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Row 2: Ê¥ªË∑ÉÊó∂ÊÆµ + Âú∞Âå∫ÂàÜÂ∏É -->
                                    <div class="row">
                                        <div class="col-lg-8">
                                            <div class="card">
                                                <div class="card-header">‚è∞ Ê¥ªË∑ÉÊó∂ÊÆµÁÉ≠Âäõ (Hourly Activity)</div>
                                                <div class="card-body">
                                                    <div class="chart-container">
                                                        <canvas id="rangeHourlyChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="card">
                                                <div class="card-header">üìç Âú∞Âå∫ÂàÜÂ∏É (Geo)</div>
                                                <div class="card-body">
                                                    <div class="chart-container">
                                                        <canvas id="rangeGeoChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Row 3: ÁÉ≠Èó®ÁªÑ‰ª∂ (Êñ∞Â¢û) -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header">üî• ÁÉ≠Èó®ÁªÑ‰ª∂ Top 10 (Popular Components)</div>
                                                <div class="card-body">
                                                    <div class="chart-container-sm">
                                                        <canvas id="rangeTargetChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ================= PANEL 2: ÊÄªËßà ================= -->
                                <div
                                    class="tab-pane fade" id="total-pane">
                                    <!-- KPI Row -->
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card kpi-card">
                                                <div class="card-body">
                                                    <small>Total Users</small>
                                                    <h3 id="total-users">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card kpi-card">
                                                <div class="card-body">
                                                    <small>Total Views</small>
                                                    <h3 id="total-tracks">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card kpi-card">
                                                <div class="card-body">
                                                    <small>Avg Time (All)</small>
                                                    <h3 id="total-time">0s</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Trend -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header">üìà ÂéÜÂè≤ËÆøÈóÆË∂ãÂäø (All Time Trend)</div>
                                                <div class="card-body">
                                                    <div class="chart-container">
                                                        <canvas id="totalTimelineChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Targets & Geo -->
                                    <div class="row">
                                        <div class="col-lg-7">
                                            <div class="card">
                                                <div class="card-header">üéØ ÁªÑ‰ª∂ÊÄªÊ¶ú (All Time Targets)</div>
                                                <div class="card-body">
                                                    <div class="chart-container-sm">
                                                        <canvas id="totalTargetChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-5">
                                            <div class="card">
                                                <div class="card-header">üåç Âú∞Âå∫ÊÄªËßà (Total Geo)</div>
                                                <div class="card-body">
                                                    <div class="chart-container-sm">
                                                        <canvas id="totalGeoChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ================= PANEL 3: ËÆæÁΩÆ (Settings) ================= -->
                                <div class="tab-pane fade" id="settings-pane">
                                    <div class="row justify-content-center">
                                        <div
                                            class="col-lg-8">

                                            <!-- 1. SMTP ÈÇÆ‰ª∂ÊúçÂä°Âô®ÈÖçÁΩÆ -->
                                            <div class="card mb-4">
                                                <div class="d-flex justify-content-end mb-3">
                                                    <button class="btn btn-sm btn-outline-info" onclick="requestTokenAndReload()">
                                                        üîÑ Reload / Change Token
                                                    </button>
                                                </div>

                                                <div class="card-header text-primary bg-primary bg-opacity-10 border-0">
                                                    üìß ÈÇÆ‰ª∂ÂèëÈÄÅÈÖçÁΩÆ (Sender / SMTP Config)
                                                </div>
                                                <div class="card-body">
                                                    <form id="smtpForm">
                                                        <div class="row g-3">
                                                            <div class="col-md-8">
                                                                <label class="form-label text-muted">SMTP Host</label>
                                                                <input type="text" class="form-control bg-dark text-white border-secondary" id="smtpHost" placeholder="e.g. smtp.gmail.com"></div>
                                                                <div class="col-md-4">
                                                                    <label class="form-label text-muted">Port</label>
                                                                    <input type="number" class="form-control bg-dark text-white border-secondary" id="smtpPort" placeholder="587"></div>
                                                                    <div class="col-md-6">
                                                                        <label class="form-label text-muted">Username (Email)</label>
                                                                        <input type="email" class="form-control bg-dark text-white border-secondary" id="smtpUser" placeholder="sender@example.com"></div>
                                                                        <div class="col-md-6">
                                                                            <label class="form-label text-muted">Password (App Password)</label>
                                                                            <input type="password" class="form-control bg-dark text-white border-secondary" id="smtpPass" placeholder="******">
                                                                                <div class="form-text text-secondary">
                                                                                    Use "App Password" if using Gmail/Outlook (Recommended).
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </div>

                                                            <!-- 2. Êé•Êî∂‰∫∫ & Ë∞ÉÂ∫¶Êó∂Èó¥ÈÖçÁΩÆ -->
                                                            <div class="card mb-4">
                                                                <div class="card-header text-success bg-success bg-opacity-10 border-0">
                                                                    üì® Êé•Êî∂‰∫∫‰∏éË∞ÉÂ∫¶ (Receivers & Schedule)
                                                                </div>
                                                                <div
                                                                    class="card-body">

                                                                    <!-- Êé•Êî∂‰∫∫ÂàóË°® -->
                                                                    <label class="form-label text-muted fw-bold">Receiver Emails</label>
                                                                    <div
                                                                        id="receivers-container" class="mb-3"><!-- JS Âä®ÊÄÅÁîüÊàêËæìÂÖ•Ê°Ü -->
                                                                    </div>
                                                                    <button class="btn btn-sm btn-outline-secondary mb-4" onclick="addReceiverField()">
                                                                        + Add Receiver
                                                                    </button>

                                                                    <hr
                                                                        class="border-secondary opacity-25">

                                                                        <!-- ÂèëÈÄÅÊó∂Èó¥ÂàóË°® -->
                                                                        <label class="form-label text-muted fw-bold">Report Schedule Times (Daily)</label>
                                                                        <div
                                                                            id="times-container" class="mb-3"><!-- JS Âä®ÊÄÅÁîüÊàêËæìÂÖ•Ê°Ü -->
                                                                        </div>
                                                                        <button class="btn btn-sm btn-outline-secondary" onclick="addTimeField()">
                                                                            + Add Time
                                                                        </button>

                                                                    </div>
                                                                </div>

                                                                <!-- 3. Êìç‰ΩúÊåâÈíÆ -->
                                                                <div class="d-flex gap-3 mb-5">
                                                                    <button class="btn btn-primary flex-grow-1 py-2 fw-bold" onclick="saveConfig()">
                                                                        üíæ Save Configuration
                                                                    </button>
                                                                    <button class="btn btn-outline-warning fw-bold" onclick="testEmail()">
                                                                        üß™ Send Test Email
                                                                    </button>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>


                                                </div>
                                            </div>

                                            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
                                            <script>
                                                // --- Config & Utils ---
                                                Chart.defaults.color = '#94a3b8';
                                                Chart.defaults.font.family = "'Inter', sans-serif";
                                                Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';

                                                // [‰øÆÊîπ] Â∞Ü const Êîπ‰∏∫ letÔºåÂπ∂‰ºòÂÖàËØªÂèñ localStorage
                                                let API_TOKEN = localStorage.getItem('admin_token') || "WPWix32CBJpLYAKiHYsx";
                                                const apiBase = '/api/stats';
                                                let configLoaded = false; // [Êñ∞Â¢û] Ê†áËÆ∞ÈÖçÁΩÆÊòØÂê¶Âä†ËΩΩÊàêÂäüÔºåÈò≤Ê≠¢Ë¶ÜÁõñÁ©∫Êï∞ÊçÆ
                                                let charts = {};

                                                function formatTime(ms) {
                                                    if (! ms) 
                                                        return '0s';
                                                    


                                                    return ms < 1000 ? ms + 'ms' : (ms / 1000).toFixed(1) + 's';
                                                }

                                                function updateClock() {
                                                    const now = new Date();
                                                    document.getElementById('clock-time').innerText = now.toLocaleTimeString('en-US', {hour12: false});
                                                    document.getElementById('clock-date').innerText = now.toLocaleDateString();
                                                }
                                                setInterval(updateClock, 1000);
                                                updateClock();

                                                // Êó•ÊúüÈáçÁΩÆÈÄªËæë
                                                function resetToToday() {
                                                    const today = new Date().toISOString().split('T')[0];
                                                    document.getElementById('startDate').value = today;
                                                    document.getElementById('endDate').value = today;
                                                    loadRangeData(); // Á´ãÂç≥Êü•ËØ¢
                                                }

                                                // ÂàùÂßãÂåñ: ÈªòËÆ§ÈÄâÊã©‰ªäÂ§©
                                                resetToToday();

                                                async function fetchData(endpoint) {
                                                    try {
                                                        const res = await fetch(`${apiBase}/${endpoint}`, {
                                                            method: 'GET',
                                                            headers: {
                                                                'Authorization': API_TOKEN, // ÂøÖÈ°ªÊê∫Â∏¶Ëøô‰∏™Â§¥
                                                                'Content-Type': 'application/json'
                                                            }
                                                        });
                                                        const json = await res.json();
                                                        return json.success ? json.data : null;
                                                    } catch (e) {
                                                        console.error(e);
                                                        return null;
                                                    }
                                                }

                                                // Ê†∏ÂøÉÊ∏≤ÊüìÂáΩÊï∞
                                                function renderChart(id, type, data, options = {}) {
                                                    const ctx = document.getElementById(id).getContext('2d');
                                                    if (charts[id]) 
                                                        charts[id].destroy();
                                                    


                                                    // ÈªòËÆ§ÈÖçÁΩÆ
                                                    const defaultOptions = {
                                                        responsive: true,
                                                        maintainAspectRatio: false,
                                                        plugins: {
                                                            legend: {
                                                                display: false
                                                            }
                                                        },
                                                        scales: {
                                                            x: {
                                                                grid: {
                                                                    display: false
                                                                }
                                                            }, // ÈªòËÆ§ÈöêËóèXÁΩëÊ†º
                                                            y: {
                                                                grid: {
                                                                    color: 'rgba(255,255,255,0.05)'
                                                                },
                                                                beginAtZero: true
                                                            }
                                                        }
                                                    };

                                                    // Ê∑±Â∫¶ÂêàÂπ∂ÈÖçÁΩÆ (ÁÆÄÂçïÁâà)
                                                    const finalOptions = {
                                                        ... defaultOptions,
                                                        ...options
                                                    };
                                                    if (options.scales) 
                                                        finalOptions.scales = {
                                                            ... defaultOptions.scales,
                                                            ...options.scales
                                                        };
                                                    


                                                    if (options.plugins) 
                                                        finalOptions.plugins = {
                                                            ... defaultOptions.plugins,
                                                            ...options.plugins
                                                        };
                                                    


                                                    charts[id] = new Chart(ctx, {type, data, options: finalOptions});
                                                }

                                                // --- 1. Âä†ËΩΩ„ÄêÂå∫Èó¥ËßÜÂõæ„ÄëÊï∞ÊçÆ ---
                                                async function loadRangeData() {
                                                    const start = document.getElementById('startDate').value;
                                                    const end = document.getElementById('endDate').value;
                                                    const query = `?startDate=${start}&endDate=${end}`;

                                                    // KPI
                                                    const overview = await fetchData(`daily/overview${query}`);
                                                    if (overview) {
                                                        document.getElementById('range-users').innerText = overview.active_users;
                                                        document.getElementById('range-tracks').innerText = overview.total_interactions;
                                                        document.getElementById('range-time').innerText = formatTime(overview.avg_stay_time);
                                                    }

                                                    // Hourly (Line)
                                                    const hourly = await fetchData(`daily/hourly${query}`);
                                                    if (hourly) {
                                                        const hours = Array.from({
                                                            length: 24
                                                        }, (_, i) => i);
                                                        const dataMap = {};
                                                        hourly.forEach(d => dataMap[d._id] = d.count);

                                                        const ctx = document.getElementById('rangeHourlyChart').getContext('2d');
                                                        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                                        gradient.addColorStop(0, 'rgba(245, 158, 11, 0.4)');
                                                        gradient.addColorStop(1, 'rgba(245, 158, 11, 0.0)');

                                                        renderChart('rangeHourlyChart', 'line', {
                                                            labels: hours.map(h => `${h}:00`),
                                                            datasets: [
                                                                {
                                                                    label: 'Interactions',
                                                                    data: hours.map(h => dataMap[h] || 0),
                                                                    borderColor: '#f59e0b',
                                                                    backgroundColor: gradient,
                                                                    fill: true,
                                                                    tension: 0.4
                                                                }
                                                            ]
                                                        });
                                                    }

                                                    // Geo (Bar)
                                                    const geo = await fetchData(`daily/geolocation${query}`);
                                                    if (geo) {
                                                        renderChart('rangeGeoChart', 'bar', {
                                                            labels: geo.map(d => d._id),
                                                            datasets: [
                                                                {
                                                                    label: 'Views',
                                                                    data: geo.map(d => d.count),
                                                                    backgroundColor: '#10b981',
                                                                    borderRadius: 4
                                                                }
                                                            ]
                                                        });
                                                    }

                                                    // Targets (Horizontal Bar) - Êñ∞Â¢û
                                                    const targets = await fetchData(`daily/targets${query}`);
                                                    if (targets) {
                                                        renderChart('rangeTargetChart', 'bar', {
                                                            labels: targets.map(d => d._id),
                                                            datasets: [
                                                                {
                                                                    label: 'Clicks',
                                                                    data: targets.map(d => d.count),
                                                                    backgroundColor: '#8b5cf6',
                                                                    borderRadius: 4
                                                                }
                                                            ]
                                                        }, {indexAxis: 'y'});
                                                    }
                                                }

                                                // --- 2. Âä†ËΩΩ„ÄêÊÄªËßà„ÄëÊï∞ÊçÆ ---
                                                async function loadTotalData() {
                                                    const ov = await fetchData('overview');
                                                    const time = await fetchData('staytime');
                                                    if (ov) {
                                                        document.getElementById('total-users').innerText = ov.total_users;
                                                        document.getElementById('total-tracks').innerText = ov.total_tracks;
                                                    }
                                                    if (time) 
                                                        document.getElementById('total-time').innerText = formatTime(time);
                                                    


                                                    // Timeline Trend (‰øÆÂ§çÁõ¥Á∫øÈóÆÈ¢ò)
                                                    const timeline = await fetchData('timeline');
                                                    if (timeline) {
                                                        const ctx = document.getElementById('totalTimelineChart').getContext('2d');
                                                        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                                        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                                                        gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

                                                        renderChart('totalTimelineChart', 'line', {
                                                            labels: timeline.map(d => d._id),
                                                            datasets: [
                                                                {
                                                                    label: 'Visits',
                                                                    data: timeline.map(d => d.count),
                                                                    borderColor: '#3b82f6',
                                                                    backgroundColor: gradient,
                                                                    fill: true,
                                                                    tension: 0.3 // Á®çÂæÆÈôç‰ΩéÂπ≥ÊªëÂ∫¶ÔºåÈÅøÂÖçÊï∞ÊçÆÂ∞ëÊó∂Êõ≤Á∫øÂ§™Â§∏Âº†
                                                                }
                                                            ]
                                                        }, {
                                                            scales: {
                                                                y: {
                                                                    beginAtZero: true,
                                                                    suggestedMax: 10, // ÂÖ≥ÈîÆÔºöÂ¶ÇÊûúÊï∞ÊçÆÂæàÂ∞ëÔºàÊØîÂ¶ÇÂè™Êúâ1ÔºâÔºåËøôËÉΩ‰øùËØÅYËΩ¥‰∏çËá≥‰∫éÂè™ÊòæÁ§∫‰∏Ä‰∏™ÁÇπ
                                                                    grid: {
                                                                        color: 'rgba(255,255,255,0.05)'
                                                                    }
                                                                }
                                                            }
                                                        });
                                                    }

                                                    // Total Targets
                                                    const targets = await fetchData('targets');
                                                    if (targets) {
                                                        renderChart('totalTargetChart', 'bar', {
                                                            labels: targets.map(d => d._id),
                                                            datasets: [
                                                                {
                                                                    data: targets.map(d => d.count),
                                                                    backgroundColor: '#8b5cf6',
                                                                    borderRadius: 4
                                                                }
                                                            ]
                                                        }, {indexAxis: 'y'});
                                                    }

                                                    // Total Geo (‰øÆÂ§ç: ÁßªÈô§ËÉåÊôØÁ∫øÊù°)
                                                    const geo = await fetchData('geolocation');
                                                    if (geo) {
                                                        renderChart('totalGeoChart', 'doughnut', {
                                                            labels: geo.map(d => d._id),
                                                            datasets: [
                                                                {
                                                                    data: geo.map(d => d.count),
                                                                    backgroundColor: [
                                                                        '#3b82f6',
                                                                        '#8b5cf6',
                                                                        '#10b981',
                                                                        '#f59e0b',
                                                                        '#ef4444'
                                                                    ],
                                                                    borderWidth: 0
                                                                }
                                                            ]
                                                        }, {
                                                            scales: {
                                                                x: {
                                                                    display: false
                                                                },
                                                                y: {
                                                                    display: false
                                                                }
                                                            }, // Âº∫Âà∂ÈöêËóèÂùêÊ†áËΩ¥
                                                            plugins: {
                                                                legend: {
                                                                    display: true,
                                                                    position: 'right'
                                                                }
                                                            }
                                                        });
                                                    }
                                                }

                                                // ===============================================
                                                // SETTINGS & HOOK CONFIGURATION LOGIC
                                                // ===============================================

                                                // 3. Âä®ÊÄÅÁîüÊàêÂ∏¶Âà†Èô§ÊåâÈíÆÁöÑËæìÂÖ•Ê°Ü
                                                function createRemovableInput(containerId, value = "", type = "text", placeholder = "") {
                                                    const container = document.getElementById(containerId);
                                                    const div = document.createElement('div');
                                                    div.className = "input-group mb-2";

                                                    div.innerHTML = `
        <input type="${type}" class="form-control bg-dark text-white border-secondary" value="${value}" placeholder="${placeholder}">
        <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">√ó</button>
    `;
                                                    container.appendChild(div);
                                                }

                                                // Ê∑ªÂä†Êé•Êî∂‰∫∫ËæìÂÖ•Ê°Ü
                                                function addReceiverField(value = "") {
                                                    createRemovableInput('receivers-container', value, 'email', 'receiver@example.com');
                                                }

                                                // Ê∑ªÂä†Êó∂Èó¥ËæìÂÖ•Ê°Ü (‰ΩøÁî®ÊµèËßàÂô®ÂéüÁîü Time Picker)
                                                function addTimeField(value = "") {
                                                    createRemovableInput('times-container', value, 'time');
                                                }

                                                // 2. ‰ªéÂêéÁ´ØÂä†ËΩΩÈÖçÁΩÆ
                                                async function loadConfig() {
                                                    // Âè™ÊúâÂú®Ê≤°Âä†ËΩΩËøáÁöÑÊÉÖÂÜµ‰∏ãÊâçÂéªËØ∑Ê±ÇÔºåÊàñËÄÖ‰Ω†Â∏åÊúõÊØèÊ¨°ÂàáÊç¢ÈÉΩÂà∑Êñ∞‰πüÂèØ‰ª•ÂéªÊéâËøô‰∏™ if
                                                    // ‰ΩÜ‰∏∫‰∫Ü‰ΩìÈ™åÈ°∫ÊªëÔºåÂª∫ËÆÆ‰øùÁïôËøô‰∏™ checkÔºåÊàñËÄÖÂú®‰øùÂ≠òÊàêÂäüÂêéÈáçÁΩÆÂÆÉ
                                                    if (configLoaded) 
                                                        return;
                                                    

                                                    try {
                                                        const res = await fetch('/api/admin/config', {
                                                            headers: {
                                                                'Authorization': API_TOKEN
                                                            }
                                                        });

                                                        // Â¶ÇÊûúÊùÉÈôê‰∏çË∂≥ (403)ÔºåÁõ¥Êé•ÁªìÊùüÔºå‰∏çÂºπÁ™óÔºå‰∏çÊâìÊâ∞Áî®Êà∑
                                                        if (res.status === 403) {
                                                            console.warn("[Silent Load] Token invalid or unauthorized. Waiting for manual update.");
                                                            return;
                                                        }

                                                        const json = await res.json();

                                                        if (json.success) {
                                                            const conf = json.data;

                                                            // Â°´ÂÖÖÊï∞ÊçÆ
                                                            document.getElementById('smtpHost').value = conf.smtp.host || "";
                                                            document.getElementById('smtpPort').value = conf.smtp.port || 465;
                                                            document.getElementById('smtpUser').value = conf.smtp.user || "";
                                                            // ÂØÜÁ†ÅÈÄöÂ∏∏‰∏çÂõûÊòæÔºåÊàñËÄÖÂè™ÊòæÁ§∫Âç†‰ΩçÁ¨¶
                                                            document.getElementById('smtpPass').value = conf.smtp.pass || "";

                                                            // Â°´ÂÖÖÊé•Êî∂‰∫∫
                                                            const rContainer = document.getElementById('receivers-container');
                                                            rContainer.innerHTML = '';
                                                            if (conf.receivers && conf.receivers.length > 0) {
                                                                conf.receivers.forEach(r => addReceiverField(r));
                                                            } else {
                                                                addReceiverField();
                                                            }

                                                            // Â°´ÂÖÖÊó∂Èó¥
                                                            const tContainer = document.getElementById('times-container');
                                                            tContainer.innerHTML = '';
                                                            if (conf.report_times && conf.report_times.length > 0) {
                                                                conf.report_times.forEach(t => addTimeField(t));
                                                            } else {
                                                                addTimeField("12:00");
                                                            }

                                                            // Ê†áËÆ∞Âä†ËΩΩÊàêÂäü
                                                            configLoaded = true;
                                                        }
                                                    } catch (e) { // ÁΩëÁªúÈîôËØØ‰πü‰∏çÂºπÁ™óÔºå‰ªÖËÆ∞ÂΩïÊó•Âøó
                                                        console.warn("[Silent Load] Failed to load config:", e);
                                                    }
                                                }

                                                // 3. ‰øùÂ≠òÈÖçÁΩÆÂà∞ÂêéÁ´Ø
                                                async function saveConfig() {
                                                    // Êî∂ÈõÜ SMTP Êï∞ÊçÆ
                                                    // [ÂÆâÂÖ®Ê£ÄÊü•] Â¶ÇÊûúÈÖçÁΩÆ‰ªéÊú™Âä†ËΩΩÊàêÂäüËøáÔºå‰øùÂ≠òÂèØËÉΩ‰ºöÂØºËá¥ÂéüÊúâÊï∞ÊçÆË¢´Á©∫Êï∞ÊçÆË¶ÜÁõñ
                                                    // ËøôÈáåÊàë‰ª¨Â∞ùËØïÂÖàÈ™åËØÅ‰∏ÄÊ¨° Token
                                                    if (! configLoaded) {
                                                        const confirmLoad = confirm("‚ö†Ô∏è ÈÖçÁΩÆÂ∞öÊú™Âä†ËΩΩÊàêÂäü (ÂèØËÉΩÊòØÊùÉÈôê‰∏çË∂≥)„ÄÇ\nÁõ¥Êé•‰øùÂ≠òÂèØËÉΩ‰ºöË¶ÜÁõñÂéüÊúâÈÖçÁΩÆ„ÄÇ\n\nÁÇπÂáª [Á°ÆÂÆö] ËæìÂÖ• Token Âπ∂ÂÖàÂä†ËΩΩÈÖçÁΩÆ„ÄÇ\nÁÇπÂáª [ÂèñÊ∂à] Âº∫Âà∂‰øùÂ≠òÂΩìÂâçË°®Âçï„ÄÇ");
                                                        if (confirmLoad) {
                                                            await requestTokenAndReload();
                                                            return;
                                                        }
                                                    }

                                                    // Êî∂ÈõÜË°®ÂçïÊï∞ÊçÆ
                                                    const smtp = {
                                                        host: document.getElementById('smtpHost').value.trim(),
                                                        port: parseInt(document.getElementById('smtpPort').value) || 465,
                                                        secure: true,
                                                        user: document.getElementById('smtpUser').value.trim(),
                                                        pass: document.getElementById('smtpPass').value.trim()
                                                    };

                                                    const receivers = [];
                                                    document.querySelectorAll('#receivers-container input').forEach(input => {
                                                        if (input.value.trim()) 
                                                            receivers.push(input.value.trim());
                                                        


                                                    });

                                                    const report_times = [];
                                                    document.querySelectorAll('#times-container input').forEach(input => {
                                                        if (input.value.trim()) 
                                                            report_times.push(input.value.trim());
                                                        


                                                    });

                                                    // ÂèëÈÄÅËØ∑Ê±Ç
                                                    try {
                                                        const res = await fetch('/api/admin/config', {
                                                            method: 'POST',
                                                            headers: {
                                                                'Authorization': API_TOKEN,
                                                                'Content-Type': 'application/json'
                                                            },
                                                            body: JSON.stringify(
                                                                {smtp, receivers, report_times}
                                                            )
                                                        });

                                                        // [Ê†∏ÂøÉ] Â¶ÇÊûúËøîÂõû 403 Á¶ÅÊ≠¢ËÆøÈóÆ -> ÂºπÂá∫ Auth Check
                                                        if (res.status === 403) {
                                                            await handleAuthFailure(saveConfig); // ‰º†ÂÖ•ÂΩìÂâçÂáΩÊï∞‰ª•‰æøÈáçËØï
                                                            return;
                                                        }

                                                        const json = await res.json();
                                                        if (json.success) {
                                                            alert("‚úÖ Configuration Saved Successfully!");
                                                            configLoaded = true; // ‰øùÂ≠òÊàêÂäü‰πüËßÜ‰∏∫Âä†ËΩΩÊàêÂäü
                                                        } else {
                                                            alert("‚ùå Error: " + json.error);
                                                        }
                                                    } catch (e) {
                                                        alert("Server Error");
                                                    }
                                                }

                                                // 4. ÂèëÈÄÅÊµãËØïÈÇÆ‰ª∂
                                                async function testEmail() { // 1. Á°ÆËÆ§ÊèêÁ§∫
                                                    const confirmed = confirm("üìß ÂèëÈÄÅÊµãËØïÊä•Ë°® (Send Test Report)\n\n" + "ËøôÂ∞ÜÊ†πÊçÆÂΩìÂâçÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÁúüÂÆûÊï∞ÊçÆÔºåÁîüÊàê‰∏Ä‰ªΩÊØîÂØπÊä•Ë°®Ôºå\n" + "Âπ∂ÂèëÈÄÅÂà∞ÈÖçÁΩÆÁöÑÊé•Êî∂‰∫∫ÈÇÆÁÆ±ÂàóË°®„ÄÇ\n\n" + "Á°ÆÂÆöË¶ÅÂèëÈÄÅÂêóÔºü");

                                                    if (! confirmed) 
                                                        return;
                                                    


                                                    // 2. ÂÆö‰πâÂèëÈÄÅÈÄªËæë (Â∞ÅË£Ö‰ª•‰æøÈáçËØï)
                                                    const performTest = async () => {
                                                        try {
                                                            const res = await fetch('/api/admin/test-email', {
                                                                method: 'POST',
                                                                headers: {
                                                                    'Authorization': API_TOKEN
                                                                }
                                                            });

                                                            // ÊùÉÈôêÊã¶Êà™
                                                            if (res.status === 403) {
                                                                await handleAuthFailure(performTest); // Â§±Ë¥•ÂàôÂºπÁ™óËæìÂÖ• Token Âπ∂ÈáçËØï
                                                                return;
                                                            }

                                                            const json = await res.json();
                                                            if (json.success) {
                                                                alert("‚úÖ ÈÇÆ‰ª∂Â∑≤ÂèëÈÄÅ! (Email Sent)\nËØ∑Ê£ÄÊü•Êî∂‰ª∂ÁÆ±ÔºåÁ°ÆËÆ§Êî∂Âà∞ÂåÖÂê´Êï∞ÊçÆË°®Ê†ºÁöÑÊä•Ë°®„ÄÇ");
                                                            } else {
                                                                alert("‚ùå ÂèëÈÄÅÂ§±Ë¥• (Failed): " + json.error);
                                                            }
                                                        } catch (e) {
                                                            alert("Connection Error");
                                                        }
                                                    };

                                                    // 3. ÊâßË°å
                                                    performTest();
                                                }

                                                // [Êñ∞Â¢û] Â§ÑÁêÜÊùÉÈôê‰∏çË∂≥ÁöÑÈÄöÁî®ÂáΩÊï∞
                                                async function handleAuthFailure(retryCallback) {
                                                    const newToken = prompt("üîí ÊùÉÈôêÈ™åËØÅÂ§±Ë¥• (Access Denied)\n\nËØ∑ËæìÂÖ• Admin Token ÁªßÁª≠:");
                                                    if (newToken) {
                                                        API_TOKEN = newToken;
                                                        localStorage.setItem('admin_token', newToken);
                                                        // ËÆ∞‰Ωè Token
                                                        // ÈÄíÂΩíÈáçËØïÂàöÊâçÁöÑÊìç‰Ωú
                                                        if (retryCallback) 
                                                            retryCallback();
                                                        


                                                    }
                                                }

                                                // [Êñ∞Â¢û] ‰∏ªÂä®ËØ∑Ê±Ç Token Âπ∂Âä†ËΩΩÈÖçÁΩÆ
                                                async function requestTokenAndReload() {
                                                    const newToken = prompt("üîÑ Please enter Admin Token to load configuration:");
                                                    if (newToken) {
                                                        API_TOKEN = newToken;
                                                        localStorage.setItem('admin_token', newToken);
                                                        await loadConfig();
                                                        if (configLoaded) {
                                                            alert("‚úÖ Config loaded!");
                                                        } else {
                                                            alert("‚ùå Load failed. Token might be wrong.");
                                                        }
                                                    }
                                                }

                                                // 5. ÁõëÂê¨ Tab ÂàáÊç¢ÔºåÂÆûÁé∞ÊáíÂä†ËΩΩ
                                                // ÂΩìÁî®Êà∑ÁÇπÂáª "Settings" Tab Êó∂ÔºåÊâçÂéªËØ∑Ê±ÇÂêéÁ´ØÂä†ËΩΩÈÖçÁΩÆ
                                                const settingsTabBtn = document.getElementById('settings-tab');
                                                settingsTabBtn.addEventListener('shown.bs.tab', () => {
                                                    loadConfig();
                                                });

                                                // Tab ÁõëÂê¨ (ÊáíÂä†ËΩΩ)
                                                const totalTabBtn = document.getElementById('total-tab');
                                                totalTabBtn.addEventListener('shown.bs.tab', () => {
                                                    loadTotalData();
                                                    window.dispatchEvent(new Event('resize'));
                                                }, {once: true});

                                                // ÁõëÂê¨ÊâÄÊúâ Tab ÂàáÊç¢‰ª•‰øÆÊ≠£ÂõæË°®Â∞∫ÂØ∏
                                                document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(el => {
                                                    el.addEventListener('shown.bs.tab', () => {
                                                        window.dispatchEvent(new Event('resize'));
                                                    });
                                                });
                                            </script>
                                        </body>
                                    </html>
                                </body>
